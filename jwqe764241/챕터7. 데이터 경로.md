# 데이터 경로의 이해

## 데이터 경로

**명령어를 실행할 때 프로세서가 명령어의 정의에 따라 데이터를 경유시키는 경로**를 데이터 경로라고 한다. 데이터는 입력장치, 프로세서, 메모리, 출력장치 등 컴퓨터의 모든 구성 요소를 경유한다. 입출력 명령이 아니라면 명렁어에 대한 데이터 경로는 프로그램 계수기, 레지스터 파일, 연산장치, 메모리 등으로 구성된다.

## 데이터 경로의 두 가지 방식

데이터 경로는 단일 사이클 방식과 다중 사이클 방식으로 구현할 수 있다.

> ex) 두 종류의 16비트덧셈장치를 이용하여 16비트로 구성된 두 수를 덧셈하는 경우
>
> 단일 사이클 덧셈장치 : 한 사이클 동안에 16개의 전가산기를 사용해 16비트를 모두 더함
>
> 다중 사이클 덧셈장치 : 하나의 전가산기를 16번 반복 사용하여 1비트씩 연산한 결과를 차례대로 저장

그리고 위의 예시를 계속하여, 각 장치의 지연시간은 다음과 같다.

- 단일 사이클 방식 : (명령어 1개) x (1사이클 / 명령어)  x (16ns / 사이클)
- 다중 사이클 방식 : (명령어 1개) x (16사이클 / 명령어) x (1ns / 사이클)



# 명령어 실행과 데이터 경로

## picoMIPS의 명령어 형식

picoMIPS는 다음과 같이 R-형식, I-형식, J-형식의 명령어 형식을 지원하고, 명령어 형식은 연산 부호에 의해 결정된다.

- R-형식 : 레지스터 2개를 사용하여 연산장치에서 처리한 후 연산 결과를 다른 레지스터에 저장하는 명령어
- I-형식 : 메모리 참조, 상수 피연산자를 가진 연산, 조건 분기 등을 수행하는 명령어
- J-형식 : 무조건 분기를 수행하는 명령어

모든 명령어는 16비트로 구성되어 있지만 필드의 개수는 각각 다르다.

## picoMIPS 명령어의 단계적 실행

- 명령어 인출 : 모든 명령어는 명령어 형식과 상관 없이 다음과 같은 작업을 통해 실행할 명령어를 인출한다.

  - PC가 가리키는 메모리의 내용인 명령어를 읽는다.
  - PC가 다음 명령어를 가리키도록 PC의 내용을 갱신한다.

  

- 명령어 해독 및 레지스터 읽기 : 실행할 명령어를 인출하면 제어장치가 명령어의 연산 부호를 해독할 수 있다. 이렇게 연산부호를 해독하는 동안 명령어를 구성 요소별로 분해하여 다음과 같은 작업을 수행할 수 있다.

  - R-형식 명령어 : 3개의 레지스터 주소를 추출하고, 그 중 2개의 레지스터 주소(rs, rt)를 이용하여 레지스터의 내용을 읽는다.
  - I-형식 명령어 : 2개의 레지스터 주소를 추출하고, 그 중 1개의 레지스터 주소 (rs) 또는 2개의 레지스터 주소 (rs, rt)를 이용하여 레지스터의 내용을 읽는다.
  - J-형식 명령어 : 레지스터의 내용을 읽을 필요가 없다.

  

- 명령어 종류별 고유 과정 : 명령어 인출과 레지스터 읽기 과정이 끝나면 이미 제어장치가 명령어의 연산 부호를 해독한 상태이다. 그러므로 연산을 수행할 수 있다.

  - 산술연산 및 논리연산 : ALU를 이용하여 연산을 수행한 후 결과를 레지스터에 저장한다.
  - 메모리 참조 : ALU를 이용하여 메모리 주소를 계산한다. 메모리와 레지스터 사이에 데이터를 이동한다.
  - 조건 분기 : 조건의 만족 여부에 따라 분기 주소로 PC를 갱신한다.
  - 무조건 분기 : PC를 조건 없이 분기 주소로 갱신한다.

## 데이터 경로의 기본 골격

- 단일 사이클 방식
  - 명령어가 동일한 사이클 동안 메모리에 두 번 이상 접근할 수도 없고 ALU도 두 번 이상 사용할 수 없기 때문에 명령어 인출, 데이터 읽기 쓰기를 하기위해 메모리는 2개로 분할한다.
  - PC 값을 갱신할 때 ALU를 사용하지 않고 별도의 PC 갱신 장치를 사용해야한다.
- 다중 사이클 방식
  - 메모리를 분할할 필요가 없고, 별도의 PC 갱신장치도 필요 없다.



# 단일 사이클 방식의 명령어 실행

> 2.2의 예시이므로 생략



# 다중 사이클 방식의 명령어 실행

## 명령어 인출

PC를 갱신하는 명령어 인출 과정과 ALU를 사용하는 명령어 고유 과정이 다른 사이클에서 수행되고, ALU를 사용하여 PC를 갱신할 수 있기 때문에 별도의 PC 갱신장치가 필요없다.

## 명령어 해독과 레지스터 읽기

한 사이클에 명령어를 해독하는 동안 레지스터 파일에 접근하고 조건 분기 명령어를 위한 메모리 주소도 계산한 후 임시 저장소에 저장한다. 만약 다음 사이클에서 임시 저장소의 내용이 필요 없다면 무시한다.

## 덧셈 명령어 실행

> 이하 생략

## 적재 명령어 실행

> 이하 생략



# 데이터 경로의 구체화와 성능 비교

## 데이터 경로의 구체화

데이터 경로의 기본 골격을 구체화하려면 다음의 문제점을 해결해야 하고, 단일 사이클 방식은 PC 갱신장치도 구체적으로 완성해야 한다.

- 하나의 입력 단자에 다수의 입력이 주어져서 충돌이 발생한다.
- picoMIPS 아키텍처의 ALU는 16비트의 데이터를 연산하지만, 명령어 레지스터에서 추출된 addr 필드와 imm 필드는 각각 12비트, 6비트 데이터이다.
- 메모리는 기본 주소 단위로 바이트를 사용한다. 그런데 분기 명령어나 적재 및 저장 명령어의 경우, addr 필드와 imm 필드가 워드 단위의 주소이다. 따라서 바이트 단위의 주소로 메모리에 접근하려면 시프터를 사용하여 두 필드를 1바이트 왼쪽으로 시프트해야 한다.

## 단일 사이클 방식과 다중 사이클 방식의 성능 비교

예시)

데이터 경로를 구성하는 각종 기능장치의 지연시간

> 메모리 : 2ns
>
> 레지스터 파일 : 1ns
>
> 연산장치 : 2ns
>
> 멀티플렉서, 부호 확장기, 시프터 등 : 0ns

명령어를 해독하는 시간은 레지스터 접근과 완전히 중첩되므로 추가적인 지연 시간이 발생하지 않는다. 

작업 부하의 평균적인 명령어 배합

> R-형식 명령어 : 44%
>
> 적재 명령어 : 24%
>
> 저장 명령어 : 12%
>
> 분기 명령어 : 20%

데이터 경로, 단일 사이클 방식의 지연 시간, 단일 사이클 방식의 지연 시간, 다중 사이클 방식의 사이클 개수는 다음과 같다. (메모리의 쓰기와 읽기에 대한 지연시간이 동일하다고 가정했기 때문에 적재 명령어의 지연 시간이 길어짐)

| 명령어 종류 | 데이터 경로                                                  | 단일 사이클 방식의 지연 시간 | 다중 사이클 방식의 사이클 개수 |
| ----------- | ------------------------------------------------------------ | ---------------------------- | ------------------------------ |
| R-형식      | 메모리 -> 레지스터 파일 -> 연산장치 -> 레지스터 파일         | 6ns                          | 4                              |
| 적재        | 메모리 -> 레지스터 파일 -> 연산장치- > 메모리 -> 레지스터 파일 | 8ns                          | 5                              |
| 저장        | 메모리 -> 레지스터 파일 -> 연산장치 -> 메모리                | 7ns                          | 4                              |
| 분기        | 메모리 -> 레지스터 파일 -> 연산장치 -> PC                    | 6ns                          | 4                              |

가변 사이클 시간은 명령어마다 클록 사이클 시간이 달라서 실현성이 없으므로 데이터 경로는 고정 사이클 시간을 사용한다.

단일 사이클 방식에서는 필요한 모든 데이터 경로를 한 사이클 동안 경유한 후 명령어 수행을 마친다. 하지만 고정 사이클 시간을 사용하므로 가장 긴 경로인 8ns가 클럭 사이클 시간이 된다.

다중 사이클 방식은 분할된 데이터 경로 조각을 사이클 마다 경유하는데, 데이터 경로 조각의 지연 시간이 각각 다르지만 고정 사이클이기 때문에 메모리 접근을 위한 2ns, 레지스터 접근을 위한 1ns, 연산장치를 위한 2ns중 가장 긴 경로인 2ns가 클록 사이클 시간이 된다. 그러나 명령어마다 경유할 데이터 경로 조각의 수가 다르므로 필요한 사이클의 개수가 달라진다.

단일 사이클 방식의 경우, CPI가 1이고 클록 사이클 시간이 8ns로 각 명령어의 실행에 대한 평균 CPU 실행 시간은 8ns, 다중 사이클 방식의 경유에는 CPI가 명령어마다 달라서 주어진 명령어 배합에 따른 가중치를 적용하여 평균 CPI를 구하면 4.24이다. 그리고 클록 사이클 시간이 2ns이므로 명령어당 평균 CPU 실행 시간은 8.48ns이다.

다중 사이클 방식이 명령어마다 다른 개수의 사이클을 사용하더라도 단일 사이클 방식이 좋은 성능을 보이지만, 곱셈과 나눗셈같은 복잡한 연산을 포함하면 단일 사이클 방식의 클록 사이클 시간이 매우 커지므로 다른 결과가 나타날 것이다. 그리고 파이프라이닝 기법을 사용하여 각 사이클마다 데이터 경로를 중첩 사용하려면 다중 사이클 방식을 도입해야 하므로 오늘날의 컴퓨터는 다중 사이클 방식의 데이터 경로를 사용한다.